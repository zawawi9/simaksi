# Spesifikasi Teknis: Aplikasi Reservasi Gunung Buthak

## 1. Ringkasan Proyek
Aplikasi ini adalah sistem reservasi fullstack untuk pendakian Gunung Buthak via Kucur. Terdiri dari frontend berbasis web untuk pendaki dan dashboard admin, serta backend PHP yang terhubung ke Supabase.

## 2. Teknologi yang Digunakan (Tech Stack)
- **Database & BaaS:** Supabase (PostgreSQL)
- **Backend:** PHP Native (tanpa framework)
- **Frontend:** HTML, JavaScript (ES6+), Tailwind CSS (via CDN)

## 3. Struktur Database (Skema Supabase)
-- AI, GUNAKAN STRUKTUR INI SEBAGAI SUMBER KEBENARAN TUNGGAL UNTUK DATABASE
-- (Salin & tempel SELURUH skrip SQL PostgreSQL yang sudah kita buat sebelumnya di sini)

-- LANGKAH 1: BUAT SEMUA TIPE KUSTOM (ENUM)
CREATE TYPE "peran_pengguna" AS ENUM ('pendaki', 'admin');
CREATE TYPE "status_reservasi" AS ENUM ('menunggu_pembayaran', 'terkonfirmasi', 'dibatalkan', 'selesai');
CREATE TYPE "status_sampah_enum" AS ENUM ('belum_dicek', 'sesuai', 'tidak_sesuai');
CREATE TYPE "jenis_sampah_enum" AS ENUM ('organik', 'non-organik');
CREATE TYPE "jenis_verifikasi" AS ENUM ('registrasi', 'reset_password');

-- LANGKAH 2: BUAT TABEL-TABEL

-- LANGKAH 1: BUAT SEMUA TIPE KUSTOM (ENUM)
CREATE TYPE "peran_pengguna" AS ENUM ('pendaki', 'admin');
CREATE TYPE "status_reservasi" AS ENUM ('menunggu_pembayaran', 'terkonfirmasi', 'dibatalkan', 'selesai');
CREATE TYPE "status_sampah_enum" AS ENUM ('belum_dicek', 'sesuai', 'tidak_sesuai');
CREATE TYPE "jenis_sampah_enum" AS ENUM ('organik', 'non-organik');
CREATE TYPE "jenis_verifikasi" AS ENUM ('registrasi', 'reset_password');


-- LANGKAH 2: BUAT TABEL-TABEL (URUTAN DIPERBAIKI)

-- >> BUAT TABEL INDEPENDEN & TABEL INDUK UTAMA TERLEBIH DAHULU <<

-- Tabel Kategori Pengeluaran (Dibuat lebih awal)
CREATE TABLE "kategori_pengeluaran" (
  "id_kategori" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "nama_kategori" VARCHAR(100) NOT NULL UNIQUE,
  "deskripsi" TEXT
);

-- Tabel Kuota Harian
CREATE TABLE "kuota_harian" (
  "id_kuota" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "tanggal_kuota" DATE NOT NULL UNIQUE,
  "kuota_maksimal" INT NOT NULL,
  "kuota_terpesan" INT NOT NULL DEFAULT 0
);

-- Tabel Poster Promosi
CREATE TABLE "promosi_poster" (
  "id_poster" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "judul_poster" VARCHAR(255) NOT NULL,
  "deskripsi_poster" TEXT,
  "url_gambar" VARCHAR(255) NOT NULL,
  "url_tautan" VARCHAR(255),
  "is_aktif" BOOLEAN NOT NULL DEFAULT TRUE,
  "urutan" INT NOT NULL DEFAULT 0,
  "dibuat_pada" TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Tabel Pengguna (SANGAT PENTING!)
CREATE TABLE "pengguna" (
  "id_pengguna" uuid PRIMARY KEY NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  "nama_lengkap" VARCHAR(100) NOT NULL,
  "email" VARCHAR(100) UNIQUE NOT NULL,
  "nomor_telepon" VARCHAR(20),
  "alamat" TEXT,
  "peran" peran_pengguna NOT NULL DEFAULT 'pendaki',
  "is_verified" BOOLEAN NOT NULL DEFAULT false,
  "dibuat_pada" TIMESTAMPTZ NOT NULL DEFAULT now()
);
COMMENT ON TABLE "pengguna" IS 'Menyimpan data profil pengguna yang terhubung ke Supabase Auth';


-- >> SEKARANG BUAT TABEL-TABEL YANG BERGANTUNG PADA TABEL DI ATAS <<

-- Tabel Reservasi (bergantung pada 'pengguna')
CREATE TABLE "reservasi" (
  "id_reservasi" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "id_pengguna" uuid NOT NULL REFERENCES "pengguna"("id_pengguna") ON DELETE CASCADE,
  "kode_reservasi" VARCHAR(20) NOT NULL UNIQUE,
  "tanggal_pendakian" DATE NOT NULL,
  "jumlah_pendaki" SMALLINT NOT NULL,
  "jumlah_tiket_parkir" SMALLINT NOT NULL DEFAULT 0,
  "total_harga" INT NOT NULL,
  "status" status_reservasi NOT NULL DEFAULT 'menunggu_pembayaran',
  "jumlah_potensi_sampah" SMALLINT,
  "status_sampah" status_sampah_enum NOT NULL DEFAULT 'belum_dicek',
  "dipesan_pada" TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Tabel Barang Bawaan Sampah (bergantung pada 'reservasi')
CREATE TABLE "barang_bawaan_sampah" (
  "id_barang" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "id_reservasi" BIGINT NOT NULL REFERENCES "reservasi"("id_reservasi") ON DELETE CASCADE,
  "nama_barang" VARCHAR(255) NOT NULL,
  "jenis_sampah" jenis_sampah_enum NOT NULL
);

-- Tabel Komentar (bergantung pada 'pengguna')
CREATE TABLE "komentar" (
  "id_komentar" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "id_pengguna" uuid NOT NULL REFERENCES "pengguna"("id_pengguna"),
  "komentar" TEXT NOT NULL,
  "dibuat_pada" TIMESTAMPTZ DEFAULT now()
);

-- Tabel Pemasukan (bergantung pada 'pengguna' dan 'reservasi')
CREATE TABLE "pemasukan" (
  "id_pemasukan" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "id_reservasi" BIGINT REFERENCES "reservasi"("id_reservasi") ON DELETE SET NULL,
  "id_admin" uuid NOT NULL REFERENCES "pengguna"("id_pengguna"),
  "jumlah" INT NOT NULL,
  "keterangan" TEXT NOT NULL,
  "tanggal_pemasukan" DATE NOT NULL,
  "dibuat_pada" TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Tabel Pendaki Rombongan (bergantung pada 'reservasi')
CREATE TABLE "pendaki_rombongan" (
  "id_pendaki" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "id_reservasi" BIGINT NOT NULL REFERENCES "reservasi"("id_reservasi") ON DELETE CASCADE,
  "nama_lengkap" VARCHAR(100) NOT NULL,
  "nik" VARCHAR(20) NOT NULL,
  "alamat" TEXT NOT NULL,
  "nomor_telepon" VARCHAR(20) NOT NULL,
  "kontak_darurat" VARCHAR(100) NOT NULL,
  "url_surat_sehat" VARCHAR(255)
);

-- Tabel Pengeluaran (bergantung pada 'pengguna' dan 'kategori_pengeluaran')
CREATE TABLE "pengeluaran" (
  "id_pengeluaran" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "id_admin" uuid NOT NULL REFERENCES "pengguna"("id_pengguna"),
  "id_kategori" BIGINT REFERENCES "kategori_pengeluaran"("id_kategori") ON DELETE SET NULL,
  "jumlah" INT NOT NULL,
  "keterangan" TEXT NOT NULL,
  "tanggal_pengeluaran" DATE NOT NULL,
  "dibuat_pada" TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Tabel Pengumuman (bergantung pada 'pengguna')
CREATE TABLE "pengumuman" (
  "id_pengumuman" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "id_admin" uuid NOT NULL REFERENCES "pengguna"("id_pengguna"),
  "judul" VARCHAR(255) NOT NULL,
  "konten" TEXT NOT NULL,
  "start_date" TIMESTAMPTZ NOT NULL,
  "end_date" TIMESTAMPTZ NOT NULL,
  "telah_terbit" BOOLEAN NOT NULL DEFAULT false,
  "dibuat_pada" TIMESTAMPTZ NOT NULL DEFAULT now(),
  "diperbarui_pada" TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Tabel Verifikasi Email (bergantung pada 'pengguna')
CREATE TABLE "verifikasi_email" (
  "id_verifikasi" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "id_pengguna" uuid REFERENCES "pengguna"("id_pengguna") ON DELETE CASCADE,
  "email" VARCHAR(100) NOT NULL,
  "token" VARCHAR(255) NOT NULL UNIQUE,
  "jenis" jenis_verifikasi NOT NULL,
  "dibuat_pada" TIMESTAMPTZ NOT NULL DEFAULT now(),
  "kadaluarsa_pada" TIMESTAMPTZ NOT NULL
);

-- =================================================================
-- BAGIAN 1: TRIGGER OTOMATIS UNTUK KUOTA
-- =================================================================
--
-- Penjelasan: Kode ini akan membuat sebuah fungsi trigger yang secara otomatis
-- menambah atau mengurangi `kuota_terpesan` di tabel `kuota_harian`
-- setiap kali ada reservasi baru atau reservasi yang dibatalkan.

-- Langkah 1.1: Buat FUNGSI yang akan dijalankan oleh trigger
CREATE OR REPLACE FUNCTION public.update_kuota_terpesan_trigger()
RETURNS TRIGGER AS $$
BEGIN
  -- KASUS 1: Jika ada reservasi BARU DIBUAT (INSERT)
  IF (TG_OP = 'INSERT') THEN
    IF NEW.status != 'dibatalkan' THEN
      UPDATE public.kuota_harian
      SET kuota_terpesan = kuota_terpesan + NEW.jumlah_pendaki
      WHERE tanggal_kuota = NEW.tanggal_pendakian;
    END IF;
  
  -- KASUS 2: Jika ada reservasi DIPERBARUI (UPDATE)
  ELSIF (TG_OP = 'UPDATE') THEN
    -- Jika status berubah dari aktif MENJADI 'dibatalkan'
    IF OLD.status != 'dibatalkan' AND NEW.status = 'dibatalkan' THEN
      UPDATE public.kuota_harian
      SET kuota_terpesan = kuota_terpesan - OLD.jumlah_pendaki
      WHERE tanggal_kuota = OLD.tanggal_pendakian;
    
    -- Jika status berubah DARI 'dibatalkan' menjadi status aktif kembali
    ELSIF OLD.status = 'dibatalkan' AND NEW.status != 'dibatalkan' THEN
      UPDATE public.kuota_harian
      SET kuota_terpesan = kuota_terpesan + NEW.jumlah_pendaki
      WHERE tanggal_kuota = NEW.tanggal_pendakian;
    END IF;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Langkah 1.2: Buat TRIGGER yang akan memanggil fungsi di atas
-- Trigger ini akan aktif setiap kali ada INSERT atau UPDATE di tabel `reservasi`
CREATE TRIGGER reservasi_kuota_trigger
AFTER INSERT OR UPDATE ON public.reservasi
FOR EACH ROW EXECUTE FUNCTION public.update_kuota_terpesan_trigger();


-- =================================================================
-- BAGIAN 2: FUNCTIONS (PENGGANTI PROCEDURE)
-- =================================================================
--
-- Penjelasan: Di PostgreSQL, `PROCEDURE` dari MySQL disebut `FUNCTION`.
-- Supabase secara otomatis akan mengenali fungsi ini sebagai "RPC" (Remote Procedure Call)
-- yang bisa Anda panggil langsung dari aplikasi Anda.

-- Fungsi 2.1: Cek Ketersediaan Kuota
CREATE OR REPLACE FUNCTION public.cek_ketersediaan_kuota(
    p_tanggal_pendakian DATE,
    p_jumlah_diminta INT
)
RETURNS BOOLEAN AS $$
DECLARE
    v_kuota_tersisa INT;
BEGIN
    SELECT (kuota_maksimal - kuota_terpesan) INTO v_kuota_tersisa
    FROM public.kuota_harian
    WHERE tanggal_kuota = p_tanggal_pendakian;

    IF v_kuota_tersisa IS NOT NULL AND v_kuota_tersisa >= p_jumlah_diminta THEN
        RETURN TRUE;
    ELSE
        RETURN FALSE;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- Fungsi 2.2: Konfirmasi Pembayaran dan Catat Pemasukan
CREATE OR REPLACE FUNCTION public.konfirmasi_pembayaran_dan_catat_pemasukan(
    input_id_reservasi INT,
    input_id_admin INT
)
RETURNS TEXT AS $$
DECLARE
    v_reservasi RECORD;
BEGIN
    -- Ambil data reservasi dan pastikan statusnya 'menunggu_pembayaran'
    SELECT * INTO v_reservasi
    FROM public.reservasi
    WHERE id_reservasi = input_id_reservasi AND status = 'menunggu_pembayaran';

    -- Jika reservasi tidak ditemukan atau statusnya salah, kirim pesan error
    IF NOT FOUND THEN
        RETURN 'Error: Reservasi tidak ditemukan atau sudah dikonfirmasi/dibatalkan.';
    END IF;

    -- Langkah 1: Ubah status reservasi menjadi 'terkonfirmasi'
    UPDATE public.reservasi
    SET status = 'terkonfirmasi'
    WHERE id_reservasi = input_id_reservasi;

    -- Langkah 2: Tambahkan data baru ke tabel pemasukan
    INSERT INTO public.pemasukan (id_reservasi, id_admin, jumlah, keterangan, tanggal_pemasukan)
    VALUES (
        input_id_reservasi,
        input_id_admin,
        v_reservasi.total_harga,
        CONCAT('Pemasukan dari tiket reservasi kode: ', v_reservasi.kode_reservasi),
        CURRENT_DATE
    );

    RETURN 'Success: Reservasi berhasil dikonfirmasi dan pemasukan dicatat.';
EXCEPTION
    WHEN OTHERS THEN
        RETURN 'Error: Terjadi kesalahan pada database.';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

## 4. Arsitektur & Alur Data
- Frontend (JavaScript) berkomunikasi langsung dengan Supabase API menggunakan ANNON KEY untuk semua operasi data publik (melihat jadwal, memesan tiket, login).
- Backend (PHP) hanya digunakan untuk operasi yang memerlukan hak akses admin (SERVICE_ROLE KEY), seperti konfirmasi pembayaran.

---

## 5. Spesifikasi Backend (PHP Native)
Buat struktur folder backend: `/api/`
Setiap file adalah satu endpoint.

### Endpoint: `POST /api/konfirmasi_pembayaran.php`
- **Tujuan:** Dipanggil oleh admin dari dashboard untuk mengonfirmasi pembayaran dan mencatat pemasukan.
- **Parameter Input:** `id_reservasi` (integer), `id_admin` (integer).
- **Logika:**
  1. Koneksikan ke Supabase menggunakan `supabase-php` dan SERVICE_ROLE_KEY.
  2. Panggil fungsi RPC `konfirmasi_pembayaran_dan_catat_pemasukan(id_reservasi, id_admin)`.
  3. Kembalikan response JSON: `{ "status": "sukses", "message": "..." }` jika berhasil, atau `{ "status": "gagal", "message": "..." }` jika gagal.

---

## 6. Spesifikasi Frontend (JavaScript + Tailwind CSS)

### Halaman: `index.html` (Landing Page & Login)
- **Tujuan:** Halaman informasi publik dan gerbang login untuk admin.
- **Layout (Tailwind):**
  - ... (deskripsi layout seperti sebelumnya)
  - Terdapat tombol/modal untuk membuka form Login.
- **Fungsionalitas Login (di file `main.js`):**
  - **Tujuan:** Memproses login untuk semua pengguna, namun hanya memberikan akses dashboard kepada admin.
  - **Logika:**
    1. Ambil `email` dan `password` dari form login.
    2. Jalankan fungsi `supabase.auth.signInWithPassword()`.
    3. [cite_start]Jika login **gagal**, tampilkan pesan error "Kombinasi email/password salah".
    4. Jika login **berhasil**:
        a. Ambil data pengguna yang sedang login dari tabel `pengguna` di Supabase untuk memeriksa kolom `peran`.
        b. [cite_start]**JIKA** `peran` pengguna adalah `'admin'`, maka lakukan redirect halaman ke `dashboard-admin.html`.
        c. **JIKA** `peran` pengguna adalah `'pendaki'`, **JANGAN redirect**. Tetap di halaman `index.html`. Tampilkan notifikasi sementara (misalnya: "Login berhasil. Silakan lakukan pemesanan tiket melalui aplikasi mobile kami.") lalu sembunyikan form login.
        

---

## 7. Konfigurasi & Inisialisasi
Buat file `config.js` untuk menyimpan koneksi ke Supabase. Gunakan placeholder untuk kredensial. Jangan menulis kunci asli di dalam kode.

// isi file `config.js`
const supabaseUrl = 'URL_PROYEK_ANDA_DISINI';
const supabaseKey = 'KUNCI_ANON_ANDA_DISINI';
export const supabase = createClient(supabaseUrl, supabaseKey);

---
## 8. Spesifikasi Frontend - Halaman Dashboard Admin
Buat file terpisah `dashboard-admin.html` dan `assets/js/admin.js`.
Halaman ini harus dilindungi; jika pengguna belum login atau perannya bukan 'admin', redirect kembali ke `index.html`.

### Layout Umum Dashboard
- Gunakan layout sidebar di kiri dan konten utama di kanan.
- Sidebar berisi link navigasi ke:
  - Manajemen Reservasi
  - Manajemen Kuota
  - Manajemen Keuangan

---

### Fitur 1: Manajemen Reservasi (PBI-08, PBI-14)
- **Tujuan:** Memvalidasi check-in pendaki dan melihat detail reservasi.
- **Layout:**
  - Di bagian atas, ada search bar untuk mencari berdasarkan Kode Booking atau Nama Ketua Rombongan.
  - Di bawahnya, ada tabel yang menampilkan daftar reservasi untuk HARI INI.
  - Kolom tabel: `Kode Booking`, `Nama Ketua`, `Tgl. Pendakian`, `Jumlah Pendaki`, `Status Pembayaran`, `Aksi`.
- **Fungsionalitas (JavaScript):**
  1. Saat halaman dimuat, ambil data dari tabel `reservasi` Supabase yang `tanggal_pendakian`-nya adalah hari ini.
  2. Search bar akan memfilter data yang ditampilkan di tabel secara real-time.
  3. Setiap baris memiliki tombol "Detail". Saat diklik:
     - Munculkan modal (popup) yang menampilkan seluruh detail rombongan (dari tabel `pendaki_rombongan`) dan daftar barang bawaan (dari `barang_bawaan_sampah`).
     - Jika status reservasi adalah `menunggu_pembayaran`, tampilkan tombol "**Konfirmasi Pembayaran & Check-in**".
  4. Saat tombol "Konfirmasi Pembayaran & Check-in" diklik:
     - Panggil endpoint backend `api/konfirmasi_pembayaran.php` dengan parameter `id_reservasi` dan `id_admin`.
     - Tampilkan notifikasi sukses atau gagal berdasarkan respons dari backend.
     - Refresh data di tabel.

---

### Fitur 2: Manajemen Kuota Harian (PBI-09)
- **Tujuan:** Mengatur jumlah maksimal kuota pendaki per hari.
- **Layout:**
  - Tampilan utama bisa berupa daftar tanggal untuk 30 hari ke depan.
  - Setiap baris tanggal menampilkan: `Tanggal`, `Kuota Maksimal Saat Ini`, `Kuota Terisi`.
  - Di bagian atas, ada form sederhana: "Pilih Tanggal" dan "Masukkan Kuota Maksimal Baru".
- **Fungsionalitas (JavaScript):**
  1. Saat halaman dimuat, ambil data dari tabel `kuota_harian`.
  2. Saat admin mengisi form dan menekan "Simpan":
     - Lakukan operasi `upsert` ke tabel `kuota_harian` Supabase. (`upsert` akan meng-update data jika tanggal sudah ada, atau membuat data baru jika belum ada).
     - Tampilkan notifikasi sukses dan refresh daftar kuota.

---

### Fitur 3: Manajemen Keuangan (PBI-13, PBI-15)
- **Tujuan:** Mencatat pengeluaran dan melihat laporan keuangan sederhana.
- **Layout:**
  - Gunakan dua Tab: "Laporan Keuangan" dan "Catat Pengeluaran Baru".
- **Fungsionalitas Tab "Laporan Keuangan":**
  1. Terdapat filter rentang tanggal ("Dari Tanggal" dan "Sampai Tanggal").
  2. Di bawah filter, ada 3 kartu ringkasan: `Total Pemasukan`, `Total Pengeluaran`, `Saldo Akhir`.
  3. Di bawah ringkasan, ada dua tabel rincian: "Rincian Pemasukan" dan "Rincian Pengeluaran" sesuai rentang tanggal yang dipilih.
  4. Saat tombol "Tampilkan Laporan" diklik, ambil data dari tabel `pemasukan` dan `pengeluaran` sesuai filter, lakukan kalkulasi `SUM`, dan tampilkan hasilnya.
- **Fungsionalitas Tab "Catat Pengeluaran Baru":**
  1. Sediakan form input untuk: `Jumlah Pengeluaran` (angka), `Tanggal`, `Keterangan` (teks), dan `Kategori` (dropdown).
  2. Pilihan untuk dropdown `Kategori` diambil dari tabel `kategori_pengeluaran`.
  3. Saat form disubmit, lakukan `insert` data baru ke tabel `pengeluaran`.